name: PR Merged Email & Comment

on:
  pull_request:
    types: [closed]

jobs:
  notify-ml:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run script
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          ML_API_URL: ${{ secrets.ML_API_URL }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          import smtplib
          from email.message import EmailMessage

          # -------------------------------
          # Inputs from GitHub Actions
          # -------------------------------
          pr_title = os.environ["PR_TITLE"]
          pr_number = os.environ["PR_NUMBER"]
          repo = os.environ["GITHUB_REPOSITORY"]
          github_token = os.environ["GITHUB_TOKEN"]
          ml_api_url = os.environ["ML_API_URL"]
          email_user = os.environ["EMAIL_USERNAME"]
          email_pass = os.environ["EMAIL_PASSWORD"]

          headers = {
              "Authorization": f"token {github_token}",
              "Accept": "application/vnd.github+json"
          }

          # -------------------------------
          # Get PR author GitHub username
          # -------------------------------
          pr_api = f"https://api.github.com/repos/{repo}/pulls/{pr_number}"
          pr_data = requests.get(pr_api, headers=headers).json()
          pr_author_login = pr_data["user"]["login"]

          # -------------------------------
          # Get PR author email (fallback)
          # -------------------------------
          user_api = f"https://api.github.com/users/{pr_author_login}"
          user_data = requests.get(user_api, headers=headers).json()

          pr_author_email = user_data.get("email") or "kasunirashmika56@gmail.com"
          emails = [pr_author_email]

          # -------------------------------
          # Call ML API (GET or POST)
          # -------------------------------
          try:
              response = requests.get(
                  ml_api_url,
                  params={"pr_title": pr_title, "top_k": 5}
              )
              response.raise_for_status()
              predictions = response.json().get("predictions", [])
              ml_text = str(predictions)
          except Exception as e:
              print(f"ML API call failed: {e}")
              ml_text = "ML API Error"

          # -------------------------------
          # Send Email Notification
          # -------------------------------
          subject = f"Your PR has been merged: {pr_title}"

          for to_email in emails:
              msg = EmailMessage()
              msg["Subject"] = subject
              msg["From"] = email_user
              msg["To"] = to_email
              msg.set_content(f"""Hi {pr_author_login}, Your PR has been successfully merged. === ML Analysis ==={ml_text}Thanks!""")
              try:
                  with smtplib.SMTP("smtp.gmail.com", 587) as s:
                      s.starttls()
                      s.login(email_user, email_pass)
                      s.send_message(msg)
                  print(f"Email sent to {to_email}")
              except Exception as e:
                  print(f"Email sending failed: {e}")

          # -------------------------------
          # Post PR Comment
          # -------------------------------
          comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          comment_payload = {
              "body": f"Hi @{pr_author_login},\n\nYour PR has been merged.\n\n### ML Analysis:\n{ml_text}\n\nThanks!"
          }

          try:
              r = requests.post(co
