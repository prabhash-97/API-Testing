name: PR Merged Email & Comment

on:
  pull_request:
    types: [closed]

jobs:
  notify-ml:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install dependencies
        run: pip install requests

      - name: Run ML API, Send Email & Comment on PR
        run: |
          import os
          import requests
          import smtplib
          from email.message import EmailMessage

          # -------------------------------
          # PR info
          # -------------------------------
          pr_title = os.environ.get("PR_TITLE")
          pr_number = os.environ.get("PR_NUMBER")
          repo = os.environ.get("GITHUB_REPOSITORY")
          github_token = os.environ.get("GITHUB_TOKEN")
          ml_api_url = os.environ.get("ML_API_URL")

          email_user = os.environ.get("EMAIL_USERNAME")
          email_pass = os.environ.get("EMAIL_PASSWORD")

          headers = {
              "Authorization": f"token {github_token}",
              "Accept": "application/vnd.github+json"
          }

          # -------------------------------
          # Get PR author email
          # -------------------------------
          pr_api = f"https://api.github.com/repos/{repo}/pulls/{pr_number}"
          pr_data = requests.get(pr_api, headers=headers).json()
          pr_author_login = pr_data["user"]["login"]

          user_api = f"https://api.github.com/users/{pr_author_login}"
          user_data = requests.get(user_api, headers=headers).json()
          pr_author_email = user_data.get("email") or "kasunirashmika56@gmail.com"
          emails = [pr_author_email]

          # -------------------------------
          # Call ML API
          # -------------------------------
          payload = {"pr_title": pr_title, "pr_number": pr_number}
          try:
              response = requests.post(ml_api_url, json=payload)
              response.raise_for_status()
              result = response.json()
              ml_text = f"Priority: {result.get('priority')}\nConfidence: {result.get('confidence')}"
          except Exception as e:
              print(f"ML API call failed: {e}")
              ml_text = "Priority: Unknown\nConfidence: 0"

          # -------------------------------
          # Send Email
          # -------------------------------
          subject = f"Your PR has been merged: {pr_title}"
          for to_email in emails:
              msg = EmailMessage()
              msg['Subject'] = subject
              msg['From'] = email_user
              msg['To'] = to_email
              msg.set_content(f"""\Hi,Your PR has been merged. ML Analysis: {ml_text} Thanks!""")
              try:
                  with smtplib.SMTP('smtp.gmail.com', 587) as s:
                      s.starttls()
                      s.login(email_user, email_pass)
                      s.send_message(msg)
                  print(f"Email sent to {to_email}")
              except Exception as e:
                  print(f"Failed to send email to {to_email}: {e}")

          # -------------------------------
          # Post Comment on PR
          # -------------------------------
          comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          comment_payload = {
              "body": f"Hi @{pr_author_login},\n\nYour PR has been merged.\n\n**ML Analysis:**\n{ml_text}\n\nThanks!"
          }
          try:
              comment_response = requests.post(comment_url, headers=headers, json=comment_payload)
              comment_response.raise_for_status()
              print("PR comment posted successfully.")
          except Exception as e:
              print(f"Failed to post PR comment: {e}")
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          ML_API_URL: ${{ secrets.ML_API_URL }}
